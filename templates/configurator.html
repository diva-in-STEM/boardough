<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{url_for('static',filename='dist/output.css')}}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.js"></script>
    <script>
        // Theme handling
        if (localStorage.getItem('color-theme') === 'dark' || (!localStorage.getItem('color-theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <script type="application/json" id="dashboard-info">{{ dashboard|tojson|safe }}</script>
    <script type="application/json" id="dashboard-sources">{{ source|tojson|safe }}</script>
    <script type="application/json" id="subroutes-data">{{ subroutes|tojson|safe }}</script>
    <title>Configuring Dashboard {{ dashboard[3] }}</title>
</head>
<body class="bg-gray-50 dark:bg-gray-900 flex h-screen overflow-hidden">
    <!-- Customization Modal -->
    <div id="customization-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-gray-800">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white" id="modal-title">Customize Widget</h3>
                    <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:cursor-pointer" onclick="closeCustomizationModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="modal-content">
                    <!-- Dynamic content will be inserted here -->
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-400 dark:hover:bg-gray-700 hover:cursor-pointer" onclick="closeCustomizationModal()">Cancel</button>
                    <button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 hover:cursor-pointer" onclick="applyCustomization()">Apply</button>
                </div>
            </div>
        </div>
    </div>
    <div id="node-config-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white dark:bg-gray-800">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white" id="node-modal-title">Configure Node</h3>
                    <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:cursor-pointer" onclick="closeNodeConfigModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="node-modal-content">
                    <!-- Dynamic content will be inserted here -->
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-400 dark:hover:bg-gray-700 hover:cursor-pointer" onclick="closeNodeConfigModal()">Cancel</button>
                    <button class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 hover:cursor-pointer" onclick="previewNodeConfig()">
                        <i class="fa fa-eye mr-1"></i>Preview
                    </button>
                    <button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 hover:cursor-pointer" onclick="applyNodeConfiguration()">
                        <i class="fa fa-save mr-1"></i>Apply
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Left Sidebar -->
    <div id="left-sidebar" class="w-64 bg-white dark:bg-gray-800 shadow-lg border-r border-gray-200 dark:border-gray-700 flex flex-col">
        <div class="p-4 flex border-b border-gray-200 dark:border-gray-700">
            <a href="/home" class="mr-3 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"><i class="fa-solid fa-right-from-bracket"></i></a>
            <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Configurator</h2>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4">
            <nav class="space-y-2">
                <button type="button" class="w-full flex items-center p-2 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 group hover:cursor-pointer" aria-controls="pages-dropdown" data-collapse-toggle="pages-dropdown">
                    <i class="fa-solid fa-file w-5 h-5 text-gray-500 dark:text-gray-400 group-hover:text-gray-700 dark:group-hover:text-gray-300"></i>
                    <span class="flex-1 ms-3 text-left rtl:text-right whitespace-nowrap">Pages</span>
                    <i class="fa-solid fa-chevron-down w-3 h-3 text-gray-500 dark:text-gray-400 group-hover:text-gray-700 dark:group-hover:text-gray-300" aria-hidden="true"></i>
                </button>
                <ul id="pages-dropdown" class="py-2 space-y-2">
                </ul>
                <button type="button" class="w-full flex items-center p-2 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 group hover:cursor-pointer" aria-controls="routes-dropdown" data-collapse-toggle="routes-dropdown">
                    <i class="fa-solid fa-network-wired w-5 h-5 text-gray-500 dark:text-gray-400 group-hover:text-gray-700 dark:group-hover:text-gray-300"></i>
                    <span class="flex-1 ms-3 text-left rtl:text-right whitespace-nowrap">Routes</span>
                    <i class="fa-solid fa-chevron-down w-3 h-3 text-gray-500 dark:text-gray-400 group-hover:text-gray-700 dark:group-hover:text-gray-300" aria-hidden="true"></i>
                </button>
                <ul id="routes-dropdown" class="hidden py-2 space-y-2">
                    {% for subroute in subroutes %}
                        <li>
                            <button type="button" class="ml-4 w-full flex items-center p-2 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 group hover:cursor-pointer">
                                <i class="fa-solid fa-plug w-3 h-3 mr-3 text-gray-500 dark:text-gray-400 group-hover:text-gray-700 dark:group-hover:text-gray-300"></i>
                                {{ subroute[1] }}
                            </button>
                        </li>
                    {% endfor %}
                </ul>
                <button type="button" class="w-full flex items-center p-2 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 group hover:cursor-pointer" aria-controls="calculations-dropdown" data-collapse-toggle="calculations-dropdown" onclick="showCalculationsPage()">
                    <i class="fa-solid fa-calculator w-5 h-5 text-gray-500 dark:text-gray-400 group-hover:text-gray-700 dark:group-hover:text-gray-300"></i>
                    <span class="flex-1 ms-3 text-left rtl:text-right whitespace-nowrap">Calculations</span>
                </button>
                <ul id="calculations-dropdown" class="hidden py-2 space-y-2">
                    <!-- Calculations will be dynamically listed here -->
                </ul>
            </nav>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Dashboard Builder</h1>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Drag widgets from the sidebar and resize them by hovering over them</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button data-theme-toggle id="theme-toggler" type="button" class="hover:cursor-pointer text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
                        <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Drop Zone / Main Content -->
        <main class="flex-1 p-6 overflow-auto">
            <div id="calculations-page" class="hidden">
                <div class="mb-6">
                    <div class="w-full flex  justify-between">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-white">Calculations</h2>
                        <button class="text-gray-400 hover:text-red-600 hover:cursor-pointer" onclick="hideCalculationsPage()"><i class="fa-solid fa-times"></i></button>
                    </div>
                    <button class="mt-2 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 hover:cursor-pointer" onclick="showCalculationModal()">Create New Calculation</button>
                </div>
                <div id="calculations-list" class="space-y-4"></div>
            </div>
            <div id="drop-zone" class="min-h-full border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 bg-white dark:bg-gray-800 relative">
                <div class="text-center text-gray-500 dark:text-gray-400 mb-8" id="drag-instructions">
                    <i class="fa-solid fa-mouse-pointer text-4xl mb-4"></i>
                    <p class="text-lg">Drag components from the right sidebar to build your dashboard</p>
                    <p class="text-sm mt-2 opacity-75">Hover over cards to see resize handles</p>
                </div>
                
                <div id="card-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 grid-rows-4 gap-6">
                    <!-- Cards will be dynamically added here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Right Sidebar (Component Library) -->
    <div id="right-sidebar" class="w-64 bg-white dark:bg-gray-800 shadow-lg border-l border-gray-200 dark:border-gray-700 flex flex-col">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Components</h2>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Drag to add, hover to resize</p>
        </div>
        <div class="flex-1 overflow-y-auto p-4" id="component-library">
            <!-- Components will be dynamically generated -->
        </div>
    </div>
    <div id="calculation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-gray-800">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white" id="calculation-modal-title">Create Calculation</h3>
                    <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:cursor-pointer" onclick="closeCalculationModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="calculation-modal-content">
                    <!-- Dynamic content will be inserted here -->
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-400 dark:hover:bg-gray-700 hover:cursor-pointer" onclick="closeCalculationModal()">Cancel</button>
                    <button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 hover:cursor-pointer" onclick="saveCalculation()">Save</button>
                </div>
            </div>
        </div>
    </div>
    <script src="{{url_for('static',filename='themes.js')}}"></script>
    <script src="{{url_for('static',filename='configurator.js')}}"></script>
    <script>
        function closeNodeConfigModal() {
            document.getElementById("node-config-modal").classList.add("hidden");
            window.currentEditingStep = null;
        }

        async function previewNodeConfig() {
            if (!window.currentEditingStep) return;
            
            const previewDiv = document.getElementById("node-preview");
            previewDiv.innerHTML = '<div class="preview-loading"><i class="fa fa-spinner fa-spin mr-2"></i>Generating preview...</div>';
            
            try {
                const config = collectNodeConfig();
                const {step, stepIndex, inputData} = window.currentEditingStep;
                
                // Create a temporary step with the new config
                const tempStep = {...step, config};
                
                // Process the step with the input data
                const result = await processCalculationStep(tempStep, inputData);
                
                // Display the result
                let displayResult = result;
                if (Array.isArray(result) && result.length > 5) {
                    displayResult = [...result.slice(0, 5), {__truncated: `... and ${result.length - 5} more items`}];
                }
                
                previewDiv.innerHTML = `<pre>${JSON.stringify(displayResult, null, 2)}</pre>`;
                
            } catch (error) {
                previewDiv.innerHTML = `<div class="preview-error">Error: ${error.message}</div>`;
            }
        }

        function collectNodeConfig() {
            if (!window.currentEditingStep) return {};
            
            const {step} = window.currentEditingStep;
            const config = {};
            
            switch(step.type) {
                case "filter":
                    config.field = document.getElementById("filter-field")?.value || "";
                    config.operator = document.getElementById("filter-operator")?.value || "equals";
                    config.value = document.getElementById("filter-value")?.value || "";
                    break;
                case "group":
                    config.field = document.getElementById("group-field")?.value || "";
                    break;
                case "sum":
                    config.field = document.getElementById("sum-field")?.value || "";
                    break;
                case "join":
                    config.joinField = document.getElementById("join-field")?.value || "";
                    config.joinSource = parseInt(document.getElementById("join-source")?.value) || 0;
                    config.joinType = document.getElementById("join-type")?.value || "inner";
                    break;
                case "map":
                    const mappings = {};
                    const newFields = document.querySelectorAll(".field-mapping-new");
                    const oldFields = document.querySelectorAll(".field-mapping-old");
                    
                    newFields.forEach((newField, index) => {
                        const oldField = oldFields[index];
                        if (newField.value && oldField.value) {
                            mappings[newField.value] = oldField.value;
                        }
                    });
                    
                    config.mapping = mappings;
                    break;
            }
            
            return config;
        }

        function applyNodeConfiguration() {
            if (!window.currentEditingStep) return;
            
            const config = collectNodeConfig();
            const {stepIndex} = window.currentEditingStep;
            
            // Validate configuration
            if (!validateNodeConfig(window.currentEditingStep.step.type, config)) {
                return;
            }
            
            // Update the step configuration
            window.currentCalcFlow[stepIndex].config = config;
            
            // Add configured class for visual feedback
            window.currentCalcFlow[stepIndex].configured = true;
            
            // Re-render the flow
            renderCalculationFlow();
            
            // Close modal
            closeNodeConfigModal();
        }

        function validateNodeConfig(stepType, config) {
            switch(stepType) {
                case "filter":
                    if (!config.field) {
                        alert("Please select a field to filter by.");
                        return false;
                    }
                    if (config.value === "") {
                        alert("Please enter a value to filter by.");
                        return false;
                    }
                    break;
                case "group":
                    if (!config.field) {
                        alert("Please select a field to group by.");
                        return false;
                    }
                    break;
                case "join":
                    if (!config.joinField) {
                        alert("Please select a field to join on.");
                        return false;
                    }
                    if (config.joinSource === undefined || config.joinSource < 0) {
                        alert("Please select a data source to join with.");
                        return false;
                    }
                    break;
                case "map":
                    if (!config.mapping || Object.keys(config.mapping).length === 0) {
                        alert("Please add at least one field mapping.");
                        return false;
                    }
                    break;
            }
            return true;
        }

        // Enhanced editCalcFlowNode function to use the new modal
        function editCalcFlowNode(index) {
            const step = window.currentCalcFlow[index];
            if (!step || step.type === "source") return;
            
            showNodeConfigModal(step, index);
        }

        async function showNodeConfigModal(step, stepIndex) {
            // Get input data for this step
            let inputData = null;
            try {
                if (stepIndex > 0) {
                    inputData = await getInputDataForStep(stepIndex);
                }
            } catch (e) {
                console.error("Error getting input data:", e);
            }
            
            const modal = document.getElementById("node-config-modal");
            const title = document.getElementById("node-modal-title");
            const content = document.getElementById("node-modal-content");
            
            title.textContent = `Configure ${step.label || step.type}`;
            
            // Store current step info for modal
            window.currentEditingStep = {step, stepIndex, inputData};
            
            content.innerHTML = generateNodeConfigForm(step, inputData);
            
            modal.classList.remove("hidden");
            
            // Add event listeners for real-time preview
            setTimeout(() => {
                addPreviewEventListeners();
            }, 100);
        }

        function addPreviewEventListeners() {
            // Add change event listeners to form inputs for real-time preview
            const inputs = document.querySelectorAll('#node-modal-content input, #node-modal-content select');
            inputs.forEach(input => {
                input.addEventListener('change', debounce(previewNodeConfig, 500));
                input.addEventListener('input', debounce(previewNodeConfig, 500));
            });
        }

        // Utility function to debounce function calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Enhanced renderCalculationFlow to show configured status
        function renderCalculationFlow() {
            const e = document.getElementById("calc-flow-dropzone");
            e.innerHTML = "";
            e.addEventListener("dragover", (function(e) { e.preventDefault() }));
            e.addEventListener("drop", handleCalcDrop);
            window.currentCalcFlow = window.currentCalcFlow || [];
            
            if (window.currentCalcFlow.length === 0) {
                e.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-center w-full">Drag data sources and operations here to build your calculation</div>';
                return;
            }
            
            window.currentCalcFlow.forEach((t, a) => {
                const n = document.createElement("div");
                let nodeClasses = "calc-flow-node bg-white dark:bg-gray-700 border border-blue-300 dark:border-blue-700 rounded px-4 py-3 flex flex-col items-center justify-center min-w-[120px] relative shadow-sm cursor-pointer";
                
                // Add configured class if the node has configuration
                if (t.config && Object.keys(t.config).length > 0) {
                    nodeClasses += " configured";
                }
                
                n.className = nodeClasses;
                
                let displayText = t.label || t.type || t.sourceName;
                if (t.config && Object.keys(t.config).length > 0) {
                    displayText += " ✓";
                }
                
                n.innerHTML = `<span class="font-semibold text-gray-900 dark:text-white">${displayText}</span>`;
                
                if (t.type !== "source" && t.inputs && t.inputs.length) {
                    n.innerHTML += `<div class="text-xs mt-2 text-gray-500 dark:text-gray-400">Inputs: ${t.inputs.map(e => e.sourceName || e.label || e.type).join(", ")}</div>`;
                }
                
                n.innerHTML += `<button class="absolute top-1 right-1 text-red-500 hover:text-red-700 w-6 h-6 flex items-center justify-center" onclick="removeCalcFlowStep(${a})" title="Remove step"><i class="fa fa-times"></i></button>`;
                
                n.onclick = function(e) {
                    if (!e.target.closest("button")) {
                        editCalcFlowNode(a);
                    }
                };
                
                e.appendChild(n);
                
                if (a < window.currentCalcFlow.length - 1) {
                    const t = document.createElement("div");
                    t.className = "calc-flow-arrow flex items-center justify-center";
                    t.innerHTML = '<span class="mx-2 text-blue-400 text-xl">→</span>';
                    e.appendChild(t);
                }
            });
        }
    </script>
</body>
</html>